---
title:  Züchtungslehre - Lösung 6
author: Peter von Rohr
date: 2016-11-11
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'asis')
devtools::load_all()
```

```{r DocumentStatus, eval=FALSE}
r6obj_docstat <- rmddochelper::R6ClassDocuStatus$new()
r6obj_docstat$set_current_status(psVersion = "0.0.901",
                                 psStatus  = "Initialisation",
                                 psProject = "ZL_HS_2016")
r6obj_docstat$include_doc_stat(psTitle = "## Document Status")
```


```{r TableAbbreviation}
r6ob_abbrtable <- rmddochelper::R6ClassTableAbbrev$new()
### # include table of abbreviations only, if there are any
if (!r6ob_abbrtable$is_empty_abbr())
  r6ob_abbrtable$include_abbr_table(psAbbrTitle = "## Abbreviations")
```

## Aufgabe 1: LDL-Zerlegung der Verwandtschaftsmatrix

Gegeben ist das folgende Pedigree

```{r PedEx1A1}
suppressPackageStartupMessages(require(pedigreemm))
nNrAni <- 5
ped <- pedigree(sire = c(NA,NA,1,1,4),dam = c(NA,NA,2,NA,2), label = as.character(1:nNrAni))
print(ped)
```

a) Stellen Sie die Verwandtschaftsmatrix $A$ auf
b) Ermitteln Sid die LDL-Zerlegung von $A$
c) Berechnen Sie die Inverse der Verwandtschaftsmatrix

__Hinweise__:

- Für Pedigrees ohne Inzucht, können die Diagonalelemente $d_{ii}$ nur drei verschiedene Werte annehmen. Diese sind entweder $1$, falls das Tier ein Foundertier ist ohne bekannte Eltern, $3/4$ falls ein Elternteil bekannt ist, oder $1/2$ falls beide Eltern bekannt sind.

- Ohne Berücksichtigung der Inzucht kann die Inverse $A^{-1}$ einfach aufgrund folgender Regeln aufgestellt werden.
    + Initialisiere alle Elemente der Matrix $A^{-1}$ mit $0$
    + Für Tier $i$ mit Eltern $s$ und $d$, 
        + addiere $\alpha_i$ zum Element $(i,i)$, 
        + addiere $-\alpha_i/2$ zu den Elementen $(s,i)$, $(i,s)$, $(d,i)$ und $(i,d)$ und 
        + addiere $\alpha_i/4$ zu den Elementen $(s,s)$, $(s,d)$, $(d,s)$ und $(d,d)$
    + Für Tier $i$ mit bekanntem Elternteil $d$,
        + addiere $\alpha_i$ zum Element $(i,i)$, 
        + addiere $-\alpha_i/2$ zu den Elementen $(d,i)$ und $(i,d)$ und 
        + addiere $\alpha_i/4$ zu den Elementen $(d,d)$
    + Für Tier $i$ mit unbekannten Eltern
        + addiere $\alpha_i$ zum Element $(i,i)$ 
        
wobei $\alpha_i$ das $i$-te Element auf der Diagonalen von $D$ ist.

__Lösung__:

a) Die Verwantschaftsmatrix 

```{r RelMatPedEx6A1}
matA <- as.matrix(getA(ped=ped))
matR <- t(chol(matA))
cat("$$A = \\left[")
cat(paste(sGetTexMatrix(pmatAMatrix = matA, pnDigits = 4), collapse = "\n"))
cat("\\right]\n")
cat("$$\n")
```


b) Die LDL-Zerlegung von $A$: Da es im Pedigree keine ingezüchteten Tiere gibt, ist die Matrix $D$ einfach zu bestimmen als.

```{r}
matD <- diag(Dmat(ped = ped))
cat("$$D = \\left[")
cat(paste(sGetTexMatrix(pmatAMatrix = matD, pnDigits = 4), collapse = "\n"))
cat("\\right]\n")
cat("$$\n")
```

Die Diagonalelemente sind $1$ für Foundertiere, $3/4$ für Tiere mit einem bekannten Elternteil und $1/2$ für Tiere mit bekannten Eltern.

Die Matrix $L$ ist eine linke untere Dreiecksmatrix, wobei Zeile $i$ dem Mittelwert der Zeilen $s$ und $d$ entsprechen, angenommen, dass die Tiere $s$ und $d$ die Eltern von Tier $i$ sind.

```{r}
matSInv <- solve(sqrt(matD))
matL <- matR %*% matSInv
cat("$$L = \\left[")
cat(paste(sGetTexMatrix(pmatAMatrix = matL, pnDigits = 4), collapse = "\n"))
cat("\\right]\n")
cat("$$\n")
```

Daraus finden wir 

```{r}
matDInv <- solve(matD)
cat("$$D^{-1} = \\left[")
cat(paste(sGetTexMatrix(pmatAMatrix = matDInv, pnDigits = 4), collapse = "\n"))
cat("\\right]\n")
cat("$$\n")
```

und 

```{r}
matLInv <- solve(matL)
cat("$$L^{-1} = \\left[")
cat(paste(sGetTexMatrix(pmatAMatrix = matLInv, pnDigits = 4), collapse = "\n"))
cat("\\right]\n")
cat("$$\n")
```

Multiplizieren wir die Inversen, dann folgt

```{r}
matAInv <- as.matrix(getAInv(ped = ped))
cat("$$A^{-1} = (L^{-1})^T * D^{-1} * L^{-1}= \\left[")
cat(paste(sGetTexMatrix(pmatAMatrix = matAInv, pnDigits = 4), collapse = "\n"))
cat("\\right]\n")
cat("$$\n")
```


## Aufgabe 2: Zuchtwert aufgrund Nachkommenleistung
```{r AssumptionsEx2}
nNrOffspring <- 10
nMeanWwg <- 1.25
nSdWwg <- 0.3
nPopMean <- 1
nH2 <- 0.35
k <- (4-nH2)/nH2
nPhenSd <- 1.1
```

Stier Elvis hat $`r nNrOffspring`$ Nachkommen. Von diesen Nachkommen wurden der tägliche Zuwachs (in kg) bis zum Absetzen aufgezeichnet. Das Merkmal hat ein Populationsmittel von $`r nPopMean`$ kg pro Tag. Die Heritabilität $h^2$ beträgt $`r nH2`$. 

```{r}
set.seed(123)
dfWeanWeightGain = data.frame(Tier=1:nNrOffspring, Zuwachs = round(rnorm(nNrOffspring, mean=nMeanWwg, sd=nSdWwg), digits = 2))
knitr::kable(dfWeanWeightGain)
nMeanZuw <- mean(dfWeanWeightGain$Zuwachs)
```

a) Schätzen Sie den Zuchtwert von Elvis für das Merkmal tägliche Zunahme bis zum Absetzen aufgrund der Nachkommenleistung
b) Wie gross ist das Bestimmtheitsmass des unter a) geschätzten Zuchtwertes
c) Berechnen Sie aufgrund des Vertrauensintervalls, dass der Zuchtwert von Elvis grösser als $+2$ kg pro Tag ist


__Lösung__:

a) Der geschätzte Zuchtwert für Elvis beträgt

$$\hat{a} = \frac{2n}{n+k}(\tilde{y} - \mu)$$

wobei $n$: Anzahl Beobachtungen, $\tilde{y}$ der Nachkommendurchschnitt, $\mu$ das Populationsmittel und $k=\frac{4-h^2}{h^2}$. Setzen wir diese Werte ein, dann folgt

$$\hat{a} = \frac{2*`r nNrOffspring`}{`r nNrOffspring`+`r k`}(`r nMeanZuw` - `r nPopMean`)
          = `r round(2*nNrOffspring/(nNrOffspring + k) * (nMeanZuw-nPopMean), digits = 2)`$$

b) Das Bestimmtheitsmass für den Zuchtwert von Elvis ist

$$B = r_{a,\tilde{y}}^2 = \frac{n}{n+k} = \frac{`r nNrOffspring`}{`r nNrOffspring`+`r k`}
    = `r round(nNrOffspring/(nNrOffspring+k), digits=3)`$$


c) 
## Aufgabe 3: Bedingungen und Schleifen (Loops) in R



```{r WriteTableOfAbbreviations, results='hide'}
r6ob_abbrtable$writeToTsvFile()
```
<!-- END of document                 -- 
  -- Below this must not be anything --> 
